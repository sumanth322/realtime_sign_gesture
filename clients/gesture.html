<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gesture Side</title>
</head>
<body>
  <h2>Gesture Side (this peer will show gestures + video)</h2>
  <video id="localVideo" autoplay playsinline muted width="320"></video>
  <video id="remoteVideo" autoplay playsinline width="320"></video>
  <div id="label" style="font-size:24px; color:crimson; margin-top:8px"></div>
  <button id="startBtn">Start Call</button>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const SIGNALING_SERVER = "http://localhost:5000";
    const ROOM = "testroom"; // same room for both clients
    const socket = io(SIGNALING_SERVER);

    let pc;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const labelDiv = document.getElementById("label");

    socket.on("connect", () => {
      console.log("Connected to signaling server");
      socket.emit("join", { room: ROOM });
    });

    socket.on("gesture", (data) => {
      labelDiv.textContent = `${data.label} (${(data.score || 0).toFixed(2)})`;
      setTimeout(() => (labelDiv.textContent = ""), 1500);
    });

    socket.on("offer", async (msg) => {
      console.log("Received offer");
      await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", { room: ROOM, sdp: pc.localDescription });
    });

    socket.on("answer", async (msg) => {
      console.log("Received answer");
      await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    });

    socket.on("ice-candidate", async (msg) => {
      if (msg.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        } catch (e) {
          console.error(e);
        }
      }
    });

    document.getElementById("startBtn").onclick = async () => {
      pc = new RTCPeerConnection();
      pc.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
      };
      pc.onicecandidate = (evt) => {
        if (evt.candidate) {
          socket.emit("ice-candidate", { room: ROOM, candidate: evt.candidate });
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true,
      });
      localVideo.srcObject = stream;
      stream.getTracks().forEach((track) => pc.addTrack(track, stream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", { room: ROOM, sdp: pc.localDescription });
      console.log("Offer sent");
    };
  </script>
</body>
</html>
